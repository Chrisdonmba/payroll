<!DOCTYPE html>
<html lang="en">

<%- include('../snippets/headers.ejs') %>

  <body>
    <div class="dash_Box">
      <i class="fa-solid fa-list toggle_btn text-white p-3 h3 shadow"></i>

      <!-- side menu -->
      <%- include('../snippets/sidebar.ejs') %>

        <!-- main section -->
        <section class="main p-3 p-md-4 shadow">
          <main>
            <header class="head_nav d-md-flex justify-content-between align-items-center">
              <a href="javascript:void(0)" class="text-decoration-none text-dark">/ Pay-roll</a>
              <!-- <div class="d-flex align-items-center gap-3">
              <input
                type="search"
                name="search"
                id="dearch"
                placeholder="Search..."
                class="form-control"
              />
              <a href="./dash-profile.html" class="text-decoration-none text-dark"
                ><i class="fa-solid fa-user"></i
              ></a>
            </div> -->
            </header>

            <!-- data table here -->
            <section class="data_table bg-white p-3 rounded mt-5">
              <!-- add to payroll -->
              <!-- <div class="add_opt mt-4">
              <label for="monthly_filter">Filter by:</label>
              <select name="monthly_filter" id="monthly_filter" class="p-2">
                <option value="january">January</option>
                <option value="february">February</option>
                <option value="march">March</option>
                <option value="april">April</option>
                <option value="may">May</option>
                <option value="june">June</option>
                <option value="july">July</option>
                <option value="august">August</option>
                <option value="september">September</option>
                <option value="october">October</option>
                <option value="november">November</option>
                <option value="december">December</option>
              </select>
            </div> -->

              <div class="table_dsp mt-3 table-responsive">
                <table id="example" class="display" style="width: 100%">
                  <thead>
                    <tr>
                      <th><input type="checkbox" class="select_all" /></th>
                      <th>Name</th>
                      <th>Position</th>
                      <th>Department</th>
                      <th>Payment due date</th>
                      <th>Salary</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (context.payments && context.payments.length> 0) { %>
                      <% context.payments.forEach(payment=> { %>
                        <tr>
                          <td><input type="checkbox" class="select_employee" /></td>

                          <!-- Display the user first name and last name -->
                          <td>
                            <%= payment.user.fName %>
                              <%= payment.user.lName %>
                          </td>

                          <!-- Display user's department if it exists -->
                          <td>
                            <% if (payment.user.department) { %>
                              <%= payment.user.department.name %>
                                <!-- Assuming 'name' is the field in Department model -->
                                <% } else { %>
                                  Not assigned
                                  <% } %>
                          </td>

                          <!-- Display user's position if it exists -->
                          <td>
                            <% if (payment.user.position) { %>
                              <%= payment.user.position.name %> <!-- Assuming 'name' is the field in Position model -->
                                <% } else { %>
                                  Not assigned
                                  <% } %>
                          </td>

                          <!-- Payment date and amount -->
                          <td>
                            <%= new Date(payment.date).toLocaleDateString() %>
                          </td>
                          <td>&#8358;<%= payment.amount %>
                          </td>

                          <!-- Payment status -->
                          <td class="text-success">Paid</td>
                        </tr>
                        <% }) %>
                          <% } else { %>
                            <p>No payments available.</p> <!-- Fallback if no payments are found -->
                            <% } %>
                  </tbody>

                  <tfoot>
                    <tr>
                      <th></th>
                      <th>Name</th>
                      <th>Position</th>
                      <th>Department</th>
                      <th>Payment due date</th>
                      <th>Salary</th>
                      <th>Status</th>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <!-- end of table -->
              <!-- add download and delete-->
              <div class="add_opt w-100 d-flex justify-content-end mt-5">
                <section class="d-flex align-items-center gap-3">
                  <!-- <button type="button" class="btn btn-danger text-white d-flex align-items-center gap-1">
                    <i class="fa-solid fa-trash"></i>Delete
                  </button> -->

                  <button type="button" class="btn add_btn text-white d-flex align-items-center gap-2">
                    <i class="fa-solid fa-download"></i>Download
                  </button>

                </section>
              </div>

            </section>


          </main>
        </section>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/2.1.2/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.1.2/js/dataTables.bootstrap5.js"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.2/css/dataTables.bootstrap5.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"
      integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <script>
      new DataTable("#example", {
        scrollX: true,
      });
    </script>

    <script>
      document.querySelector('.btn.add_btn').addEventListener('click', function () {
        // Fetch paid users data from the API
        fetch('/admin/get-paid-users')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            const paidUsers = data.paidUsers; // Extract the paid users

            // Check if there are any paid users
            if (paidUsers.length === 0) {
              alert("No users to download.");
              return;
            }

            // Prepare the data for Excel
            const worksheetData = paidUsers.map(user => ({
              'Full Name': `${user.fName}`,
              'Department': user.department ? user.department : 'N/A',
              'Position': user.position ? user.position : 'N/A',
              'Amount Paid (â‚¦)': user.amount,
              'Payment Date': new Date(user.date).toLocaleDateString(),
            }));

            // Create a worksheet from the data
            const ws = XLSX.utils.json_to_sheet(worksheetData);

            // Create a new workbook
            const wb = XLSX.utils.book_new();

            // Append the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Paid Users');

            // Generate the Excel file and trigger a download
            XLSX.writeFile(wb, 'paid_users.xlsx');
          })
          .catch(error => {
            console.error('Error fetching data:', error);
          });
      });
    </script>


  </body>

</html>